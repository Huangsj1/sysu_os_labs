# 保护模式下的中断

>来自硬件的中断被称为**硬中断**，我们在代码中使用`int`指令调用的中断被称为**软中断**。但是二者只是调用方式不同，而中断的初始化和中断描述符的设置方式等是完全相同的。

* **实模式**下，**BIOS**中集成了一些中断程序，在BIOS加电启动后这些中断程序便被放置在内存中。当我们需要调用某个中断时，我们直接在`int`指令中给出中断向量号即可。
* 但是，BIOS内置的中断程序是16位的。所以，在**保护模式**下这些代码便不再适用。不仅如此，保护模式重新对中断向量号进行编号，也就是说，即使是相同的中断向量号，其在**实模式和保护模式中的意义不再相同**。

### 保护模式下中断程序处理过程：

-   中断前的**准备**。
	- 设置IDT和IDTR
-   CPU **检查**是否有中断信号。
	- 除了我们主动调用中断或硬件产生中断外，CPU每执行完一条指令后，CPU就会去中断控制器8259A中检查是否有中断请求
-   CPU根据中断向量号到IDT中取得处理这个向量的**中断描述符**。
-   CPU根据中断描述符中的段选择符到 GDT 中找到相应的**段描述符**。
-   CPU 根据特权级的判断设定即将运行程序的**栈地址**。
-   CPU**保护现场**。
-   CPU**跳转到中断服务程序**的第一条指令开始处执行。
	- CPU会将中断描述符中的段选择子送入CS段寄存器，然后将中断描述符中的目标代码段偏移送入EIP
-   中断服务程序**运行**。
-   中断服务程序处理完成，使用**iret返回**。

![[x86-中断 2023-04-09 11.41.29.excalidraw]]


### 可编程中断控制器8259A

> 可以通过代码来修改8259A的处理优先级、屏蔽某个中断等。

![[Pasted image 20230409113946.png|400]]

1. **初始化**8259A（ICW1~4）
	* 对于主片和从片，ICW2都是用来表示当IRQ0的中断发生时，8259A会向CPU提供的中断向量号。此后，IRQ0，IRQ1，...，IRQ7的中断号为ICW2，ICW2+1，ICW2+2，...，ICW+7。其中，ICW2的低3位必须是0。这里，我们置主片的ICW2为0x20（此时时钟中断的向量号就是0x20），从片的ICW2为0x28。
2. 之后我们便可以在任何时候8259A发送**OCW字**(Operation Command Words)来实现优先级、中断屏蔽字和EOI消息的动态改变。
	* OCW1: 中断屏蔽，相应位置1表示屏蔽相应的IRQ请求 (0到7位->IRQ0~7), 发送到0x21（主片）或0xA1（从片）端口
	* OCW2：一般用于发送EOI消息，EOI消息是发送0x20, 发送到0x20（主片）或0xA0（从片）端口